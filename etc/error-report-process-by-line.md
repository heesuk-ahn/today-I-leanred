#  장애 보고와 후속 절차 문화


## 장애를 대하는 방법

* 개발자가 계속 일을 하는 한 장애는 발생할 수 밖에 없다.
* 장애가 발생했을 때 책임을 추궁하는 문화라면, __개발자들은 새로운 것을 도입해 보거나 도전적으로 무언가를 시도해 보지 못하게 되고, 그렇게 위축된 상태에서 보수적으로 운영하기 때문에 혁신이 일어나지 못하게 된다.__
* 라인에서는 장애 발생시, 개발 담당자나 운영 담당자를 꾸짖거나 책망하지 않는다.
* `Line`에서 장애에 대응할 때 초점을 맞추는 것들
  * 앞으로 어떻게 하면 같은 장애가 또 발생하지 않게 할까
  * 어떻게 하면 더 빨리 감지할까
  * 장애가 발생하더라도 그 영향 범위를 최소화 하려면 어떻게 해야 할까
  * 시스템이 자동으로 복구되게 만들 수 없을까
* 장애는 인재인 경우도 많다. __사람이 실수하더라도 그것을 시스템에서 사전에 방지할 수 있는 방법__ 이나
 새로운 사람이 왔을 때 같은 실수가 반복되는 것을 막을 수 있는 방법에 대해서도 고민이 필요하다
* 장애를 숨기지 않고 적극적으로 드러내고 공유하고 장애 회고를 통해 서로 도와주는 문화가 필요하다.

## 장애 처리 프로세스

* LINE 내 모든 서비스에서 기본적으로 장애 처리 프로세스에 대한 5가지 가이드가 있다.
  * 장애 탐지
    * 장애는 모니터링 도구의 알람이나 관계 부서 혹은 사용자의 보고를 통해서 탐지된다.
    * 특별한 서비스의 경우 24시간 감시 팀이 있고 모니터링 도구를 모니터 하다가 문제가 생기면 서비스 담당자에게 연락을 한다.
    * 라인에서는 현재 장애 알람시 메일로 전송, 메시지를 보내주는 메시지 봇, 내부 직원의 슬랙 채널, 외부 연락망 cs 등으로 장애 탐지를 하고 있다.
  * 장애 전파
    * 장애 탐지시 관련된 부서로 장애 내용 전파 / 관련 부서는 장애 발생 원인 파악
    * 장애 범위가 클 경우 광범위하게 여러 관계자들에게 전파 될 수 있는 슬랙 채널에 공유
    * 장애 전파는 장애 해결 못지않게 중요. 장애 영향을 받는 여러 팀들이 함께 대응 할 수 있기 때문이다.
  * 장애 해결
    * 장애 전파와 동시에 장애 지속, 확산되는 것을 막아야 한다.
    * 장애를 빨리 해결 하기 위해서 많이 사용하는 방법
      * 롤백
        * 보통 장애가 지속되거나 또는 확산되는 것을 빠르게 막기 위한 방법 중 하나가 롤백이다
        * 롤백 가능 여부를 빠르게 판단하는 것이 필요하다.
        * 릴리스된 내용에 데이터 스키마 변경이 포함되어 있다면 롤백이 어렵다. 롤백시에 데이터 스키마 conflict로 인해 더 큰 문제가 발생할 수 있기 때문이다.
        * (내 생각) 롤백 가능 여부를 판단하려면 __외부 세계와 내부 세계가 완전히 이전 상태로 돌아가서 맞물려 돌아갈 수 있는지 파악해야 한다.__
        * (내 생각) 하나의 어플리케이션을 `내부 세계` 라고 봤을 때, 데이터 베이스 등은 `외부 세계`이고,
         __`내부 세계`와 `외부 세계`의 연결점이 변경되었다면 `내부 세계`만의 롤백으로는 문제가 해결되지 않는다.__
        * 시니어라고 해도 큰 프로젝트에서 릴리스 내용을 모두 파악하고 있기는 쉽지않다.
        * 롤백이 불가능하다고 생각될 경우 `pull request`를 보낼 시에 `can not rollbackable` 이라는 태그를 붙여 미리 주의를 준다.
      * 서버 재기동
        * 특별한 배포는 없었는데 장애가 발생한 경우
        * 순간 트래픽이 많거나 코드 성능 문제로 인해 서버의 스레드 / 네트워크 등 리소스 부족해져 동작할 수 없게 된 경우
        * 임시 방편으로 서버를 재기동 하여 리소스를 회복하지만, 비슷한 상황에 다시 발생 할 수 있기 때문에 장비를 증설하거나 핫픽스를 준비하는 것이 좋다.
        * (내 생각) 내부 세계의 문제일 수 있지만, `외부 세계` 의 관점의 폭을 `library dependency` 까지 생각할 경우, 특정 종속 라이브러리에 코드 문제로 장애가 발생할 수 있다.
        * (내 생각) 그렇기 때문에 `library dependency` 의 버전을 변경할 때도 릴리스 된 feature 들을 확인하고, 그 변경이 우리의 서비스에 장애로 이어지지는 않을지 판단하는 것이 중요하다.
      * 장비 증설
        * 트래픽이 많이 유입된 경우에 필요한 대응책이다.
        * 이 방법은 사전에 장비 증설이 쉬운 구조로 만들어놔야 즉각적인 대응이 가능하다.
        * 미리 여분의 장비를 받아놓고 투입 가능한 상태로 유지하고, 증설이 필요한 경우 버튼 클릭, 드래그앤 드롭 등으로 바로 서비스 배포가 가능하도록 한다.
        * Kubernetes 나 cloud 서비스에서 제공하듯이 오토 스케일링 기능이 가능하다면 scale out이 좀 더 쉽게 가능해진다.
        * (내 생각) 하지만 트래픽이 많이 유입되어 서비스 scale out으로만 해결이 이루어지는 것은 아니다. 병목이 어디에서 일어나느냐에 따라 다른 문제다.
        * (내 생각) 데이터베이스 병목에서 일어나는 문제라면 앞단 서비스를 scale out을 한다고 해도 이런 장애는 즉각 해결이 되지 않는다.
        * (내 생각) 이런 경우라면, 장비 증설보다는 아키텍처 레벨에서의 수정이 필요할 수도 있다. (Ex. 중간에 메세지 큐를 사용하여 비동기 적으로 비즈니스 로직이 처리되도록 해결 하는 방법)
      * 핫픽스 배포
        * 롤백이나 재기동으로 해결하기 쉽지 않아 문제를 수정한 버전을 배포하는 방법
        * 장애 대응을 하면서 매우 중요하다고 느꼈던 점은 웹 서비스가 아니라 네이티브 앱 (android, ios)를 개발 할 때는 가능하면 서버에서 제어할 수 있도록 만드는 것이 좋다는 점이다.
        * 네이티브 앱은 배포하는데 시간이 오래 걸리기 때문에 (IOS는 리뷰를 통과해야한다.) 문제가 되는 기능을 키거나 끌 수 있도록 준비해두면 장애에 빨리 대응이 가능하다.
      * 장애 보고
        * 장애 대응이 어느정도 완료 되면, 장애 보고서 템플릿으로 장애 보고서 작성
        * 장애 보고서 템플릿 내용
          * 요약 : 장애 상황에 대해 설명
          * 장애 탐지 시간 : 장애가 최초 탐지된 시간
          * 영향 받은 서비스
          * 장애 원인
          * 타임라인과 해결 과정
          * 해결 과정과 예방책
          * 관련 문서 및 추가정보
          * 초기 보고시 장애 원인과 해결 과정은 바로 채워넣기 어려울 수 있다.
          * 원인 분석 / 예방책을 만드는 과정이 오래 걸리기 때문
          * core까지 들여다 봐야 할 수 있음. 백엔드의 경우 스레드 덤프, 메모리 덤프 프론트의 경우 자바스크립트 엔진 코드 등..
          * 그렇기 때문에 TBD (To Be Determined)로 남겨둔 채로 1차 메일 공유를 함.
      * 장애 회고
        * 장애 처리의 하이라이트. 장애를 돌아보면서 원인 분석 및 향후 대응책 논의. 보통 2단계로 진행
        * 팀 내부적으로 먼저 회고
          * 팀 내부적으로 정리된 회고를 통해 관련된 개발자들이 모여서 다시 한 번 회고 진행
        * 팀내 회고
          * 장애를 발생시킨 직접적인 원인과 근본적인 문제가 무엇인지 파악하고 해결책 마련
          * 보고서에 추가시에는 시나리오를 만든다는 느낌으로 배경이나 히스토리 등 처음 보는 사람도 이해할 수 있도록 context 공유
          * 백그라운드를 잘 모르고 `개발자 회고` 를 진행하면 배경을 잘 이해하지 못하는 경우도 있기 때문
        * 원인 분석을 하고나면 해결책을 마련하는데 크게 3가지로 나뉨
          * 1) 장애가 발생하지 않도록 막는 방법
          * 2) 장애 탐지를 개선하는 방법
          * 3) 장애 처리를 개선하는 방법
          * 가능하면, 짧은 기간 대응 가능한 것과 오랜 기간에 걸쳐서 대응해야 하는것으로 나누는 것이 좋음
          * 사람 손이 덜 가는 방향으로 만드는 것이 좋음.
          * 사람 손이 가더라도, 실천 가능한 명확한 항목, 액션이 좋음.
          * EX) 코드 리뷰를 더 꼼꼼히 하자 ==> 코드 리뷰 할 때 테스트 케이스가 추가되어 있는지 확인하는 체크리스트를 PR 템플릿에 추가
        * 개발자 회고
          * 여러 관련 개발자들이 모여 장애 타임라인을 살펴보며 문제를 되돌아 봄
          * 장애와 관련이 없는 부서의 관심있는 사람들도 모여서 같이 논의가 가능
          * 회의에서 나오는 코멘트는 바로 자리에서 논의해서 필요한 경우 해결책 액션으로 등록
        * 회고에서 자주 나오는 주요 액션 아이템들
            * 장애가 발생하지 않도록 막는 방법
              * 해당 문제를 사전에 체크할 수 있도록 유닛 테스트 또는 통합 테스트 추가
              * 같은 문제가 발생하지 않도록 장기적으로 구조 개선 (예. Synchronous 한 부분을 asynchronous 하게 개선)
              * Fast failure를 통해 리소스가 낭비되는 것을 막음 (예. 연결 (connection)에 실패하면 기다리지 말고 빠르게 실패로 처리)
            * 장애 탐지를 개선하는 방법
              * 알람 시스템에 알람 항목을 추가
              * 로그 추가
              * 여러 가지 수치를 한 번에 볼 수 있는 대시보드 만들기  
            * 장애 처리를 개선하는 방법
              * 작업 사전 공유
              * 장기적으로 개선하는 작업은 종종 비즈니스 우선순위에 밀리는 경우가 많음.
              * 때로는 개선을 위한 TF 팀이나 프로젝트를 만들어 가시화하여 진행하는 것도 방법

## 결론
  * 라인의 사례를 살펴보면 장애에 대한 __트러블 슈팅은 일관적인 방법으로 이루어 져야한다는 것을 알 수 있다.__
  * __장애 또한 어떤 패턴__ 이 있을 수 있고, 이러한 장애를 처리하는 __일련의 장애 처리 파이프라인을 통해 앞으로 이런 유사한 문제가 발생하지 않도록 미연에 처리하는 것이 중요하다.__
  * 또한 __장애에 대한 적극적인 공유 문화 / 기록하는 문화__ 는 __장기적으로 개발자들의 트러블 슈팅 능력의 향상__ 이나 __미연에 장애를 막을 수 있는 경험__ 이 될 수 있다.

참고 학습 자료 :
  * https://engineering.linecorp.com/ko/blog/line-failure-reporting-and-follow-up-process-culture/ [라인의 장애 보고와 후속 절차 문화]
